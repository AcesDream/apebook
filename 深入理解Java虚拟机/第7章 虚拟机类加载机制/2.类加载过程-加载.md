## 7.3 类加载的过程

### 7.3.1 加载

　　“加载”是“类加载”过程的一个阶段，在加载阶段，虚拟机需要完成以下3件事情：

1. 通过一个类的全限定名来获取此定义此类的二进制字节流。*并不是只能从磁盘文件读取，可以从zip包、网络、运行时计算生成、其他文件（JSP文件生成）等等。*
2. 将这个字节流所代表的的静态存储结构转换为方法区的运行时数据结构。
3. 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。

　　相对于类加载过程中的其他阶段，一个非数组类的加载阶段（准确地说，是加载阶段中获取类的二进制字节流的动作）是开发人员可控制性最强点，因为加载阶段既可以使用系统提供的引导类加载器完成，也可以由用户自定义的类加载器去完成，开发人员可以通过定义自己的类加载器去控制字节流的获取方式（即重写一个类加载器的loadClass()方法）。
  
　　对于数组类而言，情况有所不同，数组类本身不通过类加载器创建，它是由Java虚拟机直接创建的。但数组类与类加载器仍然有很密切的关系，因为数组类的元素类型（Element Type，指数组去掉所有维度的类型）最终要靠类加载器去创建，一个数组类（下面简称C）创建的过程遵循以下规则：

+ 如果数组的组件类型（Component Type，指的是数组去掉一个维度的类型）是引用类型，那就递归采用本节中定义的加载过程去加载这个组件类型，数组C将在加载该组件类型的类加载器的类名称空间上被标识，一个类必须与类加载器一起确定唯一性。
+ 如果数组的组件类型不是引用类型（例如：int\[]数组），Java虚拟机将会把数组C标记为与引导类加载器关联。
+ 数组类的可见性与它的组件类型的可见性一致，如果组件类型不是引用类型，那数组类的可见性将默认为public。

　　加载阶段完成后，虚拟机外部的二进制流就按照虚拟机所需的格式存储在方法区之中，方法区中的数据存储格式有虚拟机实现自行定义。然后再内存中实例化一个java.lang.Class类的对象（并没有明确规定是在Java堆中，对于HotSpot虚拟机而言，Class对象比较特殊，它虽然是对象，但是存放在方法去里面），这个对象将作为程序访问方法区中的这些类型数据的外部接口。

　　加载阶段和连接阶段的部分内容是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始，但这些夹在加载阶段之中进行的动作，仍然属于连接阶段的内容，这两个阶段的开始时间仍然保持着固定的先后顺序。





　　

  
  
