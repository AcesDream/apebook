### 7.3.2 验证

　　验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含了信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。从整体上看，验证阶段大致上会完成下面4个阶段的校验动作：文件格式验证、元数据验证、字节码验证、符合引用验证。

#### 1.文件格式验证

　　第一阶段要验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。这一阶段可能包括下面的验证点：

+ 是否已魔数0xCAFEBABE开头
+ 主次版本号是否在当前虚拟机处理范围之内
+ 常量池的常量中是否有不被支持的常量类型，通过检查常量tag标志
+ ……

　　该验证阶段的主要目的是保证输入的字节流能正确地解析并存储与方法区之内，格式上符合描述一个Java类型信息的要求。这阶段的验证是基于二进制字节流进行的，只有通过了这个阶段的验证后，字节流才会进入内存的方法区中进行存储，所以后面的3个验证阶段全部都是基于方法区的存储结构进行的，不会再直接操作字节流。

#### 2.元数据验证

　　第二阶段是对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求，这个阶段可能包括的验证点如下：

+ 这个类是否有父类，除了java.lang.Object之外，所有的类都应当有父类
+ 这个类的父类是否继承了不允许被继承的类（被final修饰的类）
+ 如果这个类不是抽象类，是否实现了其父类或接口之中要求实现的所有方法
+ 类中的字段、方法，是否与父类产生矛盾
+ ……

　　第二阶段的主要目的是对类的元数据信息进行语义校验，保证不存在符合Java语言规范的元数据信息。

#### 3.字节码验证

　　第三阶段是整个验证过程中最复杂的一个阶段，主要目的是通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。在第二阶段对元数据信息中的数据类型做完校验后，这个阶段将对类的方法进行校验分析，保证被校验类的方法在运行时不会做出危害虚拟机的安全事件。例如：

+ 保证任意时刻操作数栈的数据类型与指令代码序列都能配合工作，例如不会出现类似这样的情况：在操作栈放置了一个int类型的数据，使用时却按long类型来加载入本地变量表中。
+ 保证跳转指令不会跳转到方法体意外的字节码指令上。
+ 保证方法体中的类型转换时有效的

　　如果一个类方法体的字节码没有通过字节码验证，那肯定是有问题的，但如果一个方法体通过了字节码验证，也不能说明其一定就是安全的。

#### 4.符合引用验证

　　最后一个阶段的校验发生在虚拟机将符合引用转化为直接引用的时候，这个转化动作将在连接的第三阶段————解析阶段中发生。符合引用验证可以看做是对类自身以外的信息进行匹配性校验，通常需要校验下列内容：

+ 符合引用中通过字符串描述的全限定名是否能找到对应的类
+ 在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段
+ 符合引用中的类、字段、方法的访问性是否可被当前类访问。

　　符合引用验证的目的是确保解析动作能正常执行，如果无法通过符号引用验证，那么将会抛出一个java.lang.IncompatibleClassChangeError异常的子类，如java.lang.IlleagalAccessError、java.lang.NoSuchFiedlError、java.lang.NoSuchMethodError等。

　　对于虚拟机的类加载机制来说，验证阶段是一个非常重要的、但不是一定必要的阶段。